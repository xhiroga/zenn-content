---
title: "Studioとさくらインターネットでwwwあり・なしを統一する"
emoji: "🐘"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["Studio", "さくらインターネット"]
published: false
---

## 注意事項

とりあえず私の環境では動きましたが、著者はStudio・さくらともに初心者なので何も保証できません。  
[Studio公式の案内](https://note.com/studio_design/n/n195bd389a7bc)通り、Google Domainを使うのが賢明です。

## TL;DR

- CNAMEでwwwありをなしに転送する方法はStudioには効かない
- さくらのレンタルサーバでドメイン設定からwww.転送設定をする
- HTTPSでのアクセスのために、さくらの設定完了後にwww.をStudioのIPアドレスに差し替える

## 完成図

※ドメイン `hiroga-sakura.net` は適宜読み替えて下さい。

### アーキテクチャ
![](/images/studio-sakura-internet-architecture.png)

### DNS設定
![DNS設定](/images/2022-08-07-10-13-13.png)

## 前提

StudioでホストされるサイトのIPアドレスは、全て `35.194.122.208` です。  
にも関わらずどうやってサイトを出し分けているかというと、おそらく `:authority` ヘッダーを見ているものと推測されます（違ったら教えてください）  

したがって CNAMEによってwww.あり・なしを統一する方法だと、 `:authority` ヘッダーが変わらない（＆2022-08-07現在、Studioはカスタムドメインを1つしか設定できない）ことからうまく行きません。  
よってHTTPサーバーでリダイレクトを返す必要があります。

## 手順

1. さくらのレンタルサーバでドメインの設定をする
2. Studioとさくらのドメインでwww.ありのURLを設定する
3. www.なしをありに転送する


### 1. さくらのレンタルサーバでドメインの設定をする

さくらのレンタルサーバで[ドメイン/SSL](https://secure.sakura.ad.jp/rs/cp/domain/list)を開きます。

まず、「www.が付与されたサブドメインも利用する」のチェックを外します。  
![www.が付与されたサブドメインも利用する](/images/2022-08-07-10-42-35.png)

次にSSLを設定します。SSL証明書の利用種類は "Let's Encrypt" を選択しました。
![SSL証明書の利用種類を選択](/images/2022-08-07-10-34-28.png)

なお、SSL登録でエラーが表示されることがあります。私の場合、原因は以下のいずれかでした。

- www.が付与されたサブドメインも利用する がチェックされており、かつwww.が付与されたサブドメインのAレコードがさくらのレンタルサーバではなかった
- ドメイン（今回は hiroga-sakura.net）のAレコードがさくらのレンタルサーバではなかった

作業が完了したら待ちます。私の場合Let's Encryptの証明書の発行に1~2時間かかりました。


### 2. Studioとさくらのドメインでwww.ありのURLを設定する

Studioでカスタムドメインを設定します。

設定後の状態は以下のとおりです。
![Studioドメイン設定後](/images/2022-08-07-10-55-31.png)

[DNSの設定は前述のとおり](#dns設定)です。

作業が完了したらTLS証明書の発行を待ちます。
![TLS証明書を発行中...](/images/2022-08-07-11-00-23.png)

カスタマーサポートの回答から察するに、StudioではかなりのDNSサーバー上でキャッシュが失効するまで（＝伝播が完了するまで）はTLS証明書の発行が完了しないようです。  
私の場合は24時間以上待っても反映されないことが2度あり、うち一度はカスタマーサポートに対応を依頼するまで完了しませんでした。

なお、申請完了後、ドメイン設定右上の青い「公開」ボタンを押す必要があります。

### 3. www.なしをありに転送する

以下の通り、www.なしをありに転送するように設定します。ついでにHTTPS転送設定もしました。
![hiroga-sakura.net ドメイン設定](/images/2022-08-07-11-02-43.png)

www.なしのURLを開いて、www.ありにリダイレクトしていることが確認できれば完成です。
![Studioに遷移](/images/2022-08-07-11-06-15.png)


## 注意事項

- 著者はStudio・さくらともに初心者なので、本記事の内容は誤っている可能性があります。
- さくらのレンタルサーバによるリダイレクトのステータスコードは302です。301/302の違いによってページランクが喪失されることはないようですが、一般的にはwww.ありなしの統一には301を使うべきとされています。
    - [ウェブサイトの移動と URL の変更 | Google Developers](https://developers.google.com/search/docs/advanced/crawling/site-move-with-url-changes?hl=ja%EF%BC%89&visit_id=637954320565655653-2762288753&rd=1)

## まとめ

- さくらのレンタルサーバのwww.転送設定で、Studioでもwww.あり・なしが統一できました。
- Google Domainの方がオススメです。
